name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

env:
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.6.0"
  GCP_REGION: "us-central1"

jobs:
  # Determine environment
  set-environment:
    name: Set Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  # Deploy Infrastructure
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: set-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Terraform Init
        working-directory: terraform/envs/${{ needs.set-environment.outputs.environment }}
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform/envs/${{ needs.set-environment.outputs.environment }}
        run: |
          terraform plan -out=tfplan \
            -var="project_id=${{ vars.GCP_PROJECT_ID }}" \
            -var="billing_account_id=${{ vars.GCP_BILLING_ACCOUNT }}"

      - name: Terraform Apply
        working-directory: terraform/envs/${{ needs.set-environment.outputs.environment }}
        run: terraform apply -auto-approve tfplan

  # Build and Push Docker Images
  build-push-images:
    name: Build & Push Images
    needs: [set-environment, deploy-infrastructure]
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    outputs:
      dataflow_image: ${{ steps.build-dataflow.outputs.image }}
      api_image: ${{ steps.build-api.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Dataflow image
        id: build-dataflow
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.dataflow
          push: true
          tags: |
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ needs.set-environment.outputs.environment }}-dataflow/logistics-pipeline:${{ github.sha }}
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ needs.set-environment.outputs.environment }}-dataflow/logistics-pipeline:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set Dataflow image output
        run: |
          echo "image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ needs.set-environment.outputs.environment }}-dataflow/logistics-pipeline:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push API image
        id: build-api
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.api
          push: true
          tags: |
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ needs.set-environment.outputs.environment }}-analytics-api/logistics-api:${{ github.sha }}
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ needs.set-environment.outputs.environment }}-analytics-api/logistics-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy Dataflow Pipeline
  deploy-dataflow:
    name: Deploy Dataflow
    needs: [set-environment, build-push-images]
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Deploy Dataflow Flex Template
        run: |
          ./scripts/deploy_dataflow.sh \
            --project ${{ vars.GCP_PROJECT_ID }} \
            --region ${{ env.GCP_REGION }} \
            --environment ${{ needs.set-environment.outputs.environment }} \
            --image ${{ needs.build-push-images.outputs.dataflow_image }}

  # Deploy Cloud Run API
  deploy-api:
    name: Deploy API
    needs: [set-environment, build-push-images]
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ needs.set-environment.outputs.environment }}-analytics-api \
            --image ${{ needs.build-push-images.outputs.api_image }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --no-traffic

      - name: Route traffic to new revision
        run: |
          gcloud run services update-traffic ${{ needs.set-environment.outputs.environment }}-analytics-api \
            --region ${{ env.GCP_REGION }} \
            --to-latest

  # Sync DAGs to Composer
  sync-dags:
    name: Sync DAGs
    needs: [set-environment, deploy-infrastructure]
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Sync DAGs to Composer
        run: |
          ./scripts/sync_dags.sh \
            --project ${{ vars.GCP_PROJECT_ID }} \
            --environment ${{ needs.set-environment.outputs.environment }}

  # Run integration tests
  integration-tests:
    name: Integration Tests
    needs: [set-environment, deploy-dataflow, deploy-api, sync-dags]
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v \
            --environment=${{ needs.set-environment.outputs.environment }}
        env:
          GCP_PROJECT: ${{ vars.GCP_PROJECT_ID }}
          ENVIRONMENT: ${{ needs.set-environment.outputs.environment }}

  # Production deployment requires approval
  deploy-prod:
    name: Deploy to Production
    if: github.event.inputs.environment == 'prod' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    needs: [integration-tests]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.logistics.example.com
    steps:
      - name: Deployment approved
        run: echo "Production deployment approved and completed"

  # Post-deployment smoke tests
  smoke-tests:
    name: Smoke Tests
    needs: [set-environment, integration-tests]
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Run smoke tests
        run: |
          pytest tests/e2e/ -v -m smoke \
            --environment=${{ needs.set-environment.outputs.environment }}
        env:
          GCP_PROJECT: ${{ vars.GCP_PROJECT_ID }}
          ENVIRONMENT: ${{ needs.set-environment.outputs.environment }}
